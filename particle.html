<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Interactive 3D Particles</title>
    <style>
        /* --- General Reset & Fonts --- */
        body { margin: 0; overflow: hidden; background-color: #050505; color: white; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* --- 3D Canvas --- */
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* --- Video Feed (Bottom Left) --- */
        #video-container { 
            position: absolute; bottom: 30px; left: 30px; 
            width: 220px; height: 165px; z-index: 2; 
            border: 2px solid rgba(255,255,255,0.1); 
            border-radius: 12px; overflow: hidden; 
            transform: scaleX(-1); /* Mirror effect */
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            background: #000;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #video-container.hidden { opacity: 0; transform: scaleX(-1) translateY(20px); pointer-events: none; }
        
        /* Live Badge */
        .live-badge {
            position: absolute; top: 10px; right: 10px; 
            background: #ff0055; width: 8px; height: 8px; border-radius: 50%;
            box-shadow: 0 0 10px #ff0055; z-index: 5;
            animation: pulse 2s infinite;
            transform: scaleX(-1);
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        video { width: 100%; height: 100%; object-fit: cover; }

        /* --- UI Controls (Top Right) --- */
        #controls {
            position: absolute; top: 30px; right: 30px; z-index: 20;
            display: flex; gap: 15px;
        }
        .btn {
            border-radius: 8px; 
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white; 
            padding: 12px 24px; 
            cursor: pointer; 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            font-size: 14px; font-weight: 600; 
            transition: all 0.3s ease;
            text-transform: uppercase; letter-spacing: 1px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn:hover { 
            background: rgba(255, 255, 255, 0.2); 
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px); 
            box-shadow: 0 8px 15px rgba(0,0,0,0.2); 
        }
        .btn:active { transform: scale(0.98); }

        /* --- INSTRUCTION PANEL --- */
        #instruction-panel {
            position: absolute; top: 30px; left: 30px; z-index: 10;
            background: rgba(20, 20, 30, 0.75);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            padding: 25px; 
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.4s ease;
            width: 280px;
        }
        #instruction-panel.hidden { transform: translateX(-40px); opacity: 0; pointer-events: none; }

        .panel-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 20px; padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .panel-title {
            font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            background: linear-gradient(90deg, #00C9FF 0%, #92FE9D 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        
        /* CLOSE BUTTON */
        .close-btn { 
            display: block; 
            background: none; 
            border: none; 
            color: rgba(255, 255, 255, 0.6); 
            font-size: 24px; 
            cursor: pointer; 
            padding: 0 5px;
            line-height: 1;
            transition: color 0.2s;
        }
        .close-btn:hover { color: #ff4444; }

        .gesture-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        
        .gesture-item {
            display: flex; align-items: center; gap: 12px;
            padding: 8px 12px; border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
            transition: background 0.2s ease;
        }
        .gesture-item:hover { background: rgba(255, 255, 255, 0.08); }

        .icon { font-size: 18px; width: 24px; text-align: center; }
        .gesture-text { display: flex; flex-direction: column; }
        .key { font-size: 12px; color: rgba(255,255,255,0.6); font-weight: 500; }
        .value { font-size: 14px; color: white; font-weight: 600; letter-spacing: 0.5px; }

        .highlight-box {
            margin-top: 15px; padding: 12px;
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%);
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);
        }
        .highlight-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
        .highlight-row:last-child { margin-bottom: 0; }
        .h-key { color: #92FE9D; font-weight: bold; }

        /* --- START SCREEN --- */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505;
            z-index: 100; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background-image: linear-gradient(rgba(0, 201, 255, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 201, 255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            transition: opacity 0.5s ease;
        }
        
        .logo-text { font-size: 2.5rem; font-weight: 800; margin-bottom: 40px; background: linear-gradient(135deg, #00C9FF 0%, #92FE9D 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; text-align: center;}

        #start-btn {
            position: relative;
            padding: 18px 50px; font-size: 18px;
            background: transparent; color: #00C9FF;
            border: 2px solid #00C9FF;
            font-weight: 700; letter-spacing: 2px; text-transform: uppercase;
            border-radius: 50px; cursor: pointer; overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 201, 255, 0.2);
            transition: all 0.3s ease;
        }
        #start-btn:hover { background: #00C9FF; color: #000; box-shadow: 0 0 40px rgba(0, 201, 255, 0.6); transform: scale(1.05); }

        .loading-container { margin-top: 30px; display: none; flex-direction: column; align-items: center; gap: 15px; }
        .loader-bar { width: 200px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; position: relative; }
        .loader-progress { position: absolute; top: 0; left: 0; height: 100%; width: 50%; background: #00C9FF; animation: slide 1.5s infinite ease-in-out; }
        @keyframes slide { 0% { left: -50%; } 100% { left: 100%; } }
        .status-text { color: #666; font-size: 12px; font-family: monospace; letter-spacing: 1px; }

        /* --- RESPONSIVE LOGIC --- */
        @media (max-width: 768px) {
            /* 1. Camera: Keep bottom left, but smaller */
            #video-container { 
                width: 100px; height: 133px; 
                bottom: 20px; left: 20px; 
                top: auto; /* ensure it's not at top */
                border-width: 1px; 
            }
            
            /* 2. Buttons: Keep Top Right */
            #controls { 
                top: 20px; right: 20px; 
                bottom: auto; 
                width: auto; 
            }
            /* Ensure text is VISIBLE on mobile */
            .btn { padding: 10px 16px; font-size: 12px; }
            
            /* 3. Instruction Panel: Centered */
            #instruction-panel {
                top: 50%; left: 50%; transform: translate(-50%, -50%);
                width: 85%; max-width: 320px;
            }
            #instruction-panel.hidden { transform: translate(-50%, -40%); opacity: 0; pointer-events: none; }
            
            .logo-text { font-size: 1.8rem; }
        }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

<div id="start-screen">
    <div class="logo-text">INTERACTIVE 3D PARTICLES SYSTEM</div>
    <button id="start-btn">LAUNCH EXPERIENCE</button>
    <div class="loading-container" id="loader">
        <div class="loader-bar"><div class="loader-progress"></div></div>
        <div class="status-text">INITIALIZING VISION ENGINE...</div>
    </div>
</div>

<div id="controls">
    <button class="btn" onclick="toggleInstructions()">
        <span>‚ÑπÔ∏è</span> <span>Guide</span>
    </button>
    <button class="btn" onclick="toggleCamera()">
        <span>üìπ</span> <span>Camera</span>
    </button>
</div>

<div id="instruction-panel">
    <div class="panel-header">
        <div class="panel-title">Gesture Command</div>
        <button class="close-btn" onclick="toggleInstructions()">&times;</button>
    </div>
    
    <div class="gesture-grid">
        <div class="gesture-item">
            <span class="icon">‚úä</span>
            <div class="gesture-text">
                <span class="key">Fist</span>
                <span class="value">Sphere (Default)</span>
            </div>
        </div>
        <div class="gesture-item">
            <span class="icon">‚òùÔ∏è</span>
            <div class="gesture-text">
                <span class="key">1 Finger</span>
                <span class="value">Fireworks</span>
            </div>
        </div>
        <div class="gesture-item">
            <span class="icon">‚úåÔ∏è</span>
            <div class="gesture-text">
                <span class="key">2 Fingers</span>
                <span class="value">Heart Shape</span>
            </div>
        </div>
        <div class="gesture-item">
            <span class="icon">üëå</span>
            <div class="gesture-text">
                <span class="key">3 Fingers</span>
                <span class="value">Saturn Planet</span>
            </div>
        </div>
        <div class="gesture-item">
            <span class="icon">üññ</span>
            <div class="gesture-text">
                <span class="key">4 Fingers</span>
                <span class="value">Flower Bloom</span>
            </div>
        </div>
    </div>

    <div class="highlight-box">
        <div class="highlight-row">
            <span class="h-key">ü§è Pinch</span>
            <span>Resize Particles</span>
        </div>
        <div style="height: 8px;"></div>
        <div class="highlight-row">
            <span class="h-key">üëã Move Hand (L/R)</span>
            <span>Change Color</span>
        </div>
    </div>
</div>

<div id="video-container">
    <div class="live-badge"></div>
    <video id="input_video" playsinline webkit-playsinline></video>
</div>

<div id="canvas-container"></div>

<script type="x-shader/x-vertex" id="vertexshader">
    attribute float size;
    attribute vec3 customColor;
    varying vec3 vColor;
    uniform float uScale;
    
    void main() {
        vColor = customColor;
        vec4 mvPosition = modelViewMatrix * vec4(position * uScale, 1.0);
        gl_PointSize = size * (300.0 / -mvPosition.z);
        gl_Position = projectionMatrix * mvPosition;
    }
</script>

<script type="x-shader/x-fragment" id="fragmentshader">
    uniform vec3 color;
    varying vec3 vColor;
    
    void main() {
        vec2 coord = gl_PointCoord - vec2(0.5);
        if(length(coord) > 0.5) discard;
        float strength = 1.0 - (length(coord) * 2.0);
        strength = pow(strength, 3.0);
        gl_FragColor = vec4(color * vColor, strength);
    }
</script>

<script>
    // --- UI Logic ---
    function toggleInstructions() {
        document.getElementById('instruction-panel').classList.toggle('hidden');
    }
    
    function toggleCamera() {
        document.getElementById('video-container').classList.toggle('hidden');
    }

    const isMobile = window.innerWidth < 768;
    if(isMobile) {
        setTimeout(() => { document.getElementById('instruction-panel').classList.add('hidden'); }, 5000);
    }

    // --- Core Logic (Exact Settings Preserved) ---
    const PARTICLE_COUNT = 15000;
    const MORPH_SPEED = 0.08;
    
    // Three.js Setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 100;

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    // Geometry & Buffers
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(PARTICLE_COUNT * 3);
    const colors = new Float32Array(PARTICLE_COUNT * 3);
    const sizes = new Float32Array(PARTICLE_COUNT);
    const currentPositions = new Float32Array(PARTICLE_COUNT * 3);
    
    const targets = { sphere: [], heart: [], flower: [], saturn: [], fireworks: [] };

    // Helper: Random point in Sphere
    function getSpherePoint(r) {
        const u = Math.random();
        const v = Math.random();
        const theta = 2 * Math.PI * u;
        const phi = Math.acos(2 * v - 1);
        return {
            x: r * Math.sin(phi) * Math.cos(theta),
            y: r * Math.sin(phi) * Math.sin(theta),
            z: r * Math.cos(phi)
        };
    }

    // Shape Generation
    for (let i = 0; i < PARTICLE_COUNT; i++) {
        const s = getSpherePoint(30);
        targets.sphere.push(s.x, s.y, s.z);
        
        positions[i*3] = s.x; positions[i*3+1] = s.y; positions[i*3+2] = s.z;
        currentPositions[i*3] = s.x; currentPositions[i*3+1] = s.y; currentPositions[i*3+2] = s.z;
        colors[i*3] = 1; colors[i*3+1] = 1; colors[i*3+2] = 1;
        
        sizes[i] = 3.0;

        // Heart
        const t = Math.random() * Math.PI * 2;
        const p = Math.random() * Math.PI;
        const hx = 16 * Math.pow(Math.sin(t), 3);
        const hy = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
        const hz = 5 * Math.cos(p) * Math.sin(t); 
        targets.heart.push(hx * 1.5, hy * 1.5, hz * 2 + (Math.random()-0.5)*5);

        // Flower
        const fTheta = Math.random() * Math.PI * 2;
        const fPhi = Math.random() * Math.PI;
        const r = 25 + 10 * Math.sin(5 * fTheta) * Math.sin(5 * fPhi);
        targets.flower.push(
            r * Math.sin(fPhi) * Math.cos(fTheta),
            r * Math.sin(fPhi) * Math.sin(fTheta),
            r * Math.cos(fPhi)
        );

        // Saturn
        if (i < PARTICLE_COUNT * 0.3) {
            const core = getSpherePoint(12);
            targets.saturn.push(core.x, core.y, core.z);
        } else {
            const angle = Math.random() * Math.PI * 2;
            const dist = 25 + Math.random() * 15;
            targets.saturn.push(Math.cos(angle) * dist, (Math.random() - 0.5), Math.sin(angle) * dist);
        }

        // Fireworks
        targets.fireworks.push((Math.random()-0.5)*200, (Math.random()-0.5)*200, (Math.random()-0.5)*200);
    }

    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    geometry.setAttribute('customColor', new THREE.BufferAttribute(colors, 3));
    geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

    const material = new THREE.ShaderMaterial({
        uniforms: {
            color: { value: new THREE.Color(0xffffff) },
            uScale: { value: 1.0 }
        },
        vertexShader: document.getElementById('vertexshader').textContent,
        fragmentShader: document.getElementById('fragmentshader').textContent,
        blending: THREE.AdditiveBlending,
        depthTest: false,
        transparent: true
    });

    const particleSystem = new THREE.Points(geometry, material);
    scene.add(particleSystem);

    // --- State & Hand Logic ---
    let activeTarget = 'sphere';
    let pinchDistance = 1.0;
    let handX = 0.5;
    const videoElement = document.getElementById('input_video');
    
    function onResults(results) {
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            handX = landmarks[0].x;

            const thumb = landmarks[4];
            const index = landmarks[8];
            const distance = Math.sqrt(Math.pow(thumb.x - index.x, 2) + Math.pow(thumb.y - index.y, 2));
            pinchDistance = Math.max(0.5, Math.min(3.0, distance * 10));

            const isFingerUp = (tip, pip) => landmarks[tip].y < landmarks[pip].y;
            let fingersUp = 0;
            if (isFingerUp(8, 6)) fingersUp++; 
            if (isFingerUp(12, 10)) fingersUp++; 
            if (isFingerUp(16, 14)) fingersUp++; 
            if (isFingerUp(20, 18)) fingersUp++; 

            if (fingersUp === 1) activeTarget = 'fireworks';
            else if (fingersUp === 2) activeTarget = 'heart';
            else if (fingersUp === 3) activeTarget = 'saturn';
            else if (fingersUp === 4) activeTarget = 'flower';
            else activeTarget = 'sphere';
        }
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    hands.onResults(onResults);

    // --- Start Sequence ---
    const startBtn = document.getElementById('start-btn');
    const loader = document.getElementById('loader');
    const startScreen = document.getElementById('start-screen');

    startBtn.addEventListener('click', () => {
        startBtn.style.display = 'none';
        loader.style.display = 'flex';
        
        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: isMobile ? 480 : 640,
            height: isMobile ? 640 : 480
        });
        
        cameraUtils.start().then(() => {
            startScreen.style.opacity = '0';
            setTimeout(() => { startScreen.style.display = 'none'; }, 500);
        }).catch(err => {
            loader.innerHTML = "<span style='color:#ff4444; font-weight:bold'>CAMERA BLOCKED. PLEASE REFRESH.</span>";
        });
    });

    // --- Loop ---
    function animate() {
        requestAnimationFrame(animate);

        const targetArr = targets[activeTarget];
        const array = geometry.attributes.position.array;
        for (let i = 0; i < PARTICLE_COUNT * 3; i++) {
            currentPositions[i] += (targetArr[i] - currentPositions[i]) * MORPH_SPEED;
            array[i] = currentPositions[i];
        }
        geometry.attributes.position.needsUpdate = true;

        particleSystem.rotation.y += 0.002;
        if(activeTarget === 'saturn') particleSystem.rotation.z = 0.5;
        else particleSystem.rotation.z = 0;

        material.uniforms.uScale.value += (pinchDistance - material.uniforms.uScale.value) * 0.1;

        const hue = handX; 
        const colorObj = new THREE.Color().setHSL(hue, 1.0, 0.5);
        material.uniforms.color.value.lerp(colorObj, 0.05);

        renderer.render(scene, camera);
    }
    
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    animate();
</script>
</body>
</html>